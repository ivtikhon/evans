---
domain: EC2
  types:
    - instance:
        states:
          - created
          - running
          - terminated
    - volume:
        states:
          - created
          - attached:
              requires:
                - objects[?type == 'instance'][?state == 'running']
                # volume requies a instance to be attached to
                # volume can't be attached to more than one instance
                - objects[$this][?state == 'created']
                - objects[$this][?state != 'mounted']
          - detached
    - filesystem:
        state:
          - created:
              requires:
                - domain[?element == 'volume'][?state == 'attached']
                - domain[?element == 'instance'][?state == 'running']
                # file system can span across multiple volumes
                # file system can be mounted to one instance only (as it's not shared)
          - mounted:
              requires:
                - domain[?element == 'filesystem'][?state == 'created']
                - domain[?element == 'volume'][?state == 'attached']
                - domain[?element == 'instance'][?state == 'running']
    - application:
        states:
          - running:
              requires:
                - domain[?element == 'instance'][?state == 'running']
                - domain[?element == 'application'][?state == 'installed']
          - installed:
              requires:
    - directory:
        states:
          - exists:
              requires:
                - domain[?element == 'filesystem'][?state == 'mounted']
                - domain[?element == 'instance'][?state == 'running']
    - url:
        states:
          - exists
    - file:
        states:
          - exits:
              requires:
                - domain[?element == 'filesystem'][?state == 'mounted']
                - domain[?element == 'instance'][?state == 'running']
                - domain[?element == 'directory'][?state == 'exists']
